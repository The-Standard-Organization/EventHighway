name: PR Linter

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - reopened
      - closed
    branches:
      - main

jobs:
  label:
    name: Label
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Apply Label
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prefixes = [
              'INFRA:',
              'PROVISIONS:',
              'RELEASES:',
              'DATA:',
              'BROKERS:',
              'FOUNDATIONS:',
              'PROCESSINGS:',
              'ORCHESTRATIONS:',
              'COORDINATIONS:',
              'MANAGEMENTS:',
              'AGGREGATIONS:',
              'CONTROLLERS:',
              'CLIENTS:',
              'EXPOSERS:',
              'PROVIDERS:',
              'BASE:',
              'COMPONENTS:',
              'VIEWS:',
              'PAGES:',
              'ACCEPTANCE:',
              'INTEGRATIONS:',
              'CODE RUB:',
              'MINOR FIX:',
              'MEDIUM FIX:',
              'MAJOR FIX:',
              'DOCUMENTATION:',
              'CONFIG:',
              'STANDARD:',
              'DESIGN:',
              'BUSINESS:'
            ];
            const pr = context.payload.pull_request;
            if (!pr) return;
            const title = pr.title;
            const existingLabels = pr.labels.map(l => l.name);
            for (const prefix of prefixes) {
              if (title.startsWith(prefix)) {
                const label = prefix.slice(0, -1);
                if (!existingLabels.includes(label)) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    labels: [label]
                  });
                }
                break;
              }
            }

  requireIssueOrTask:
    name: Require Issue Or Task Association
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Validate PR description
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull request context.");
              return;
            }
            if (pr.user?.login === "dependabot[bot]") {
              return;
            }
            const body = pr.body || "";
            if (!body.trim()) {
              core.setFailed("PR description must reference an issue.");
              return;
            }
            const normalized = body.replace(/\s+/g, " ");
            const issueRegex = /(close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved)\s+(#\d+|AB#\d+)/i;
            if (!issueRegex.test(normalized)) {
              core.setFailed("PR description must reference an issue using closes/fixes/resolves.");
            }
